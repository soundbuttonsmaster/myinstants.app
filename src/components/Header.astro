---
import { fetchCategories } from '../lib/api';

// Fetch categories server-side
const categories = await fetchCategories();

// Helper function to create URL-friendly slugs
function slugify(text: string): string {
  return text
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g, '') // Remove special characters
    .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
}
---

<header class="header">
  <div class="header-container">
    <!-- Logo -->
    <div class="logo">
      <a href="/">MYINSTANTS</a>
    </div>

    <!-- Desktop Navigation -->
    <nav class="nav desktop-nav">
      <a href="/" class="nav-link">HOME</a>
      <a href="/new" class="nav-link">NEW</a>
      <a href="/trending" class="nav-link">TRENDS</a>
      <div class="nav-link dropdown" id="categoriesDropdown">
        CATEGORIES
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6"/>
        </svg>
        {categories.length > 0 && (
          <div class="dropdown-menu" id="categoriesMenu">
            {categories.map((category) => (
              <div class="dropdown-item-wrapper">
                <a href={`/${slugify(category.name)}/${category.id}`} class="dropdown-item">
                  {category.name}
                  {category.children && category.children.length > 0 && (
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="dropdown-arrow">
                      <path d="M9 18l6-6-6-6"/>
                    </svg>
                  )}
                </a>
                {category.children && category.children.length > 0 && (
                  <div class="dropdown-submenu">
                    {category.children.map((child) => (
                      <a href={`/${slugify(child.name)}/${child.id}`} class="dropdown-item submenu-item">
                        {child.name}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
      <a href="/play-random" class="nav-link">PLAY RANDOM</a>
      <a href="/upload" class="nav-link">UPLOAD</a>
    </nav>

    <!-- Desktop Search Bar -->
    <div class="header-search desktop-search">
      <div class="search-wrapper">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search for files..." 
          id="headerSearchInput"
        />
        <button class="search-button" aria-label="Search">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Desktop User Actions -->
    <div class="user-actions desktop-actions">
      <a href="/login" class="btn btn-login">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        Login
      </a>
      <a href="/signup" class="btn btn-signup">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Sign Up
      </a>
      <a href="/upload" class="btn btn-upload">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Upload
      </a>
    </div>

    <!-- Mobile Icons -->
    <div class="mobile-header-actions">
      <button class="mobile-search-btn" id="mobileSearchBtn" aria-label="Search">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
      </button>
      <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="menu-icon">
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="close-icon" style="display: none;">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Full Screen Menu -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay">
    <div class="mobile-menu-content">
      <!-- Mobile Search -->
      <div class="mobile-search-section">
        <div class="mobile-search-wrapper">
          <input 
            type="text" 
            class="mobile-search-input" 
            placeholder="Search for files..." 
            id="mobileSearchInput"
          />
          <button class="mobile-search-submit" aria-label="Search">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile Navigation -->
      <nav class="mobile-nav">
        <a href="/" class="mobile-nav-link">HOME</a>
        <a href="/new" class="mobile-nav-link">NEW</a>
        <a href="/trending" class="mobile-nav-link">TRENDS</a>
        <div class="mobile-nav-link mobile-categories-toggle" id="mobileCategoriesToggle">
          CATEGORIES
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="categories-arrow">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </div>
        <div class="mobile-categories-menu" id="mobileCategoriesMenu">
          {categories.length > 0 && categories.map((category) => (
            <a href={`/${slugify(category.name)}/${category.id}`} class="mobile-nav-link mobile-category-link">
              {category.name}
            </a>
          ))}
        </div>
        <a href="/play-random" class="mobile-nav-link">PLAY RANDOM</a>
        <a href="/upload" class="mobile-nav-link">UPLOAD</a>
      </nav>

      <!-- Mobile User Actions -->
      <div class="mobile-user-actions">
        <a href="/login" class="mobile-btn mobile-btn-login">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          Login
        </a>
        <a href="/signup" class="mobile-btn mobile-btn-signup">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Sign Up
        </a>
        <a href="/upload" class="mobile-btn mobile-btn-upload">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
          </svg>
          Upload
        </a>
      </div>
    </div>
  </div>
</header>

<script>
  // Header search functionality
  const headerSearchInput = document.getElementById('headerSearchInput');
  const headerSearchButton = document.querySelector('.header-search .search-button');
  
  function handleHeaderSearch() {
    const query = headerSearchInput?.value.trim();
    if (query) {
      window.location.href = `/search?q=${encodeURIComponent(query)}`;
    }
  }
  
  headerSearchButton?.addEventListener('click', handleHeaderSearch);
  headerSearchInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleHeaderSearch();
    }
  });

  // Mobile search functionality
  const mobileSearchInput = document.getElementById('mobileSearchInput');
  const mobileSearchSubmit = document.querySelector('.mobile-search-submit');
  const mobileSearchBtn = document.getElementById('mobileSearchBtn');
  
  function handleMobileSearch() {
    const query = mobileSearchInput?.value.trim();
    if (query) {
      window.location.href = `/search?q=${encodeURIComponent(query)}`;
    }
  }
  
  mobileSearchSubmit?.addEventListener('click', handleMobileSearch);
  mobileSearchInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleMobileSearch();
    }
  });

  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
  const menuIcon = mobileMenuBtn?.querySelector('.menu-icon');
  const closeIcon = mobileMenuBtn?.querySelector('.close-icon');
  
  function toggleMobileMenu() {
    if (mobileMenuOverlay) {
      const isOpen = mobileMenuOverlay.classList.contains('active');
      if (isOpen) {
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
        if (menuIcon) menuIcon.style.display = 'block';
        if (closeIcon) closeIcon.style.display = 'none';
      } else {
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        if (menuIcon) menuIcon.style.display = 'none';
        if (closeIcon) closeIcon.style.display = 'block';
      }
    }
  }
  
  mobileMenuBtn?.addEventListener('click', toggleMobileMenu);
  
  // Close menu when clicking overlay
  mobileMenuOverlay?.addEventListener('click', (e) => {
    if (e.target === mobileMenuOverlay) {
      toggleMobileMenu();
    }
  });

  // Mobile categories toggle
  const mobileCategoriesToggle = document.getElementById('mobileCategoriesToggle');
  const mobileCategoriesMenu = document.getElementById('mobileCategoriesMenu');
  const categoriesArrow = mobileCategoriesToggle?.querySelector('.categories-arrow');
  
  mobileCategoriesToggle?.addEventListener('click', () => {
    if (mobileCategoriesMenu) {
      mobileCategoriesMenu.classList.toggle('active');
      if (categoriesArrow) {
        categoriesArrow.style.transform = mobileCategoriesMenu.classList.contains('active') 
          ? 'rotate(180deg)' 
          : 'rotate(0deg)';
      }
    }
  });

  // Categories dropdown functionality (desktop)
  const categoriesDropdown = document.getElementById('categoriesDropdown');
  const categoriesMenu = document.getElementById('categoriesMenu');
  
  if (categoriesDropdown && categoriesMenu) {
    let dropdownTimeout = null;
    
    const updateDropdownPosition = () => {
      if (categoriesMenu.style.display === 'block' || categoriesMenu.style.display === '') {
        const rect = categoriesDropdown.getBoundingClientRect();
        categoriesMenu.style.top = `${rect.bottom + window.scrollY + 8}px`;
        categoriesMenu.style.left = `${rect.left + window.scrollX}px`;
      }
    };
    
    const showDropdown = () => {
      if (dropdownTimeout) {
        clearTimeout(dropdownTimeout);
        dropdownTimeout = null;
      }
      categoriesDropdown.classList.add('active');
      categoriesMenu.style.display = 'block';
      updateDropdownPosition();
    };
    
    const hideDropdown = () => {
      dropdownTimeout = window.setTimeout(() => {
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      }, 150);
    };
    
    categoriesDropdown.addEventListener('mouseenter', showDropdown);
    categoriesDropdown.addEventListener('mouseleave', hideDropdown);
    
    categoriesMenu.addEventListener('mouseenter', showDropdown);
    categoriesMenu.addEventListener('mouseleave', hideDropdown);

    // Handle click - don't prevent default, allow links to work
    categoriesDropdown.addEventListener('click', (e) => {
      // Only toggle if clicking the button itself, not a link inside
      if (e.target === categoriesDropdown || categoriesDropdown.contains(e.target as Node)) {
        const isLink = (e.target as HTMLElement).closest('a');
        if (!isLink) {
          e.stopPropagation();
          const isActive = categoriesDropdown.classList.contains('active');
          if (isActive) {
            categoriesDropdown.classList.remove('active');
            categoriesMenu.style.display = 'none';
          } else {
            categoriesDropdown.classList.add('active');
            categoriesMenu.style.display = 'block';
            updateDropdownPosition();
          }
        }
      }
    });

    // Allow category links to navigate immediately - don't block them
    const categoryLinks = categoriesMenu.querySelectorAll('a.dropdown-item');
    categoryLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        // Clear any pending hide timeout when clicking a link
        if (dropdownTimeout) {
          clearTimeout(dropdownTimeout);
          dropdownTimeout = null;
        }
        // Allow navigation to proceed immediately
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      });
    });

    // Update position on scroll and resize
    window.addEventListener('scroll', updateDropdownPosition, true);
    window.addEventListener('resize', updateDropdownPosition);

    // Update submenu positions
    const updateSubmenuPositions = () => {
      document.querySelectorAll('.dropdown-item-wrapper').forEach((wrapper) => {
        const submenu = wrapper.querySelector('.dropdown-submenu');
        if (submenu && wrapper.matches(':hover')) {
          const wrapperRect = wrapper.getBoundingClientRect();
          (submenu as HTMLElement).style.top = `${wrapperRect.top + window.scrollY}px`;
          (submenu as HTMLElement).style.left = `${wrapperRect.right + window.scrollX + 8}px`;
        }
      });
    };

    categoriesMenu.addEventListener('mouseover', updateSubmenuPositions);

    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (!categoriesDropdown.contains(target) && !categoriesMenu.contains(target)) {
        if (dropdownTimeout) {
          clearTimeout(dropdownTimeout);
          dropdownTimeout = null;
        }
        categoriesDropdown.classList.remove('active');
        categoriesMenu.style.display = 'none';
      }
    });
  }
</script>

