---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SoundButton from '../components/SoundButton.astro';
import { fetchSounds } from '../lib/api';

// Fetch a large pool of sounds for random selection
const soundsData = await fetchSounds({ page_size: 200 });

// Get a random sound to display initially
function getRandomSound(sounds: any[]) {
  if (sounds.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * sounds.length);
  return sounds[randomIndex];
}

const initialRandomSound = getRandomSound(soundsData.results);

// SEO Meta Data
const pageTitle = 'Play Random Sound - Random Sound Button Generator | Myinstants';
const pageDescription = 'Play random sound buttons instantly! Click the button to hear a random sound effect, meme sound, or audio clip from our collection of 100,000+ sounds.';
const pageKeywords = 'random sound, play random, random sound button, random sound generator, random audio, random sound effect';
const canonicalUrl = 'https://myinstants.app/play-random';
const ogImage = 'https://myinstants.app/images/og-image.jpg';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={pageDescription} />
    <meta name="keywords" content={pageKeywords} />
    <meta name="author" content="Myinstants" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="revisit-after" content="7 days" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="Myinstants" />
    <meta property="og:locale" content="en_US" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImage} />
    
    <!-- Additional SEO Tags -->
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Play Random Sound",
      "description": pageDescription,
      "url": canonicalUrl
    })} />
    
    <!-- Favicon Links -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <link rel="stylesheet" href="/styles/global.css" />
  </head>
  <body>
    <Header />
    
    <main class="main-content">
      <div class="random-page-container">
        <!-- Hero Section -->
        <div class="random-hero">
          <h1 class="random-title">Play Random Sound</h1>
          <p class="random-description">
            Discover unexpected sounds from our collection! Click the button below to play a random sound effect, meme sound, or audio clip. 
            You never know what you'll find - from funny pranks to viral memes, epic sound effects, and everything in between!
          </p>
        </div>

        <!-- Random Sound Display -->
        <div class="random-sound-container" id="randomSoundContainer">
          {initialRandomSound ? (
            <div class="random-sound-wrapper">
              <SoundButton sound={initialRandomSound} />
            </div>
          ) : (
            <p class="no-sounds">No sounds available.</p>
          )}
        </div>

        <!-- Get Another Random Button -->
        <div class="random-button-container">
          <button id="playRandomBtn" class="random-button" type="button">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
            </svg>
            Get Another Random Sound
          </button>
        </div>
      </div>
    </main>

    <Footer />

    <script define:vars={{ sounds: soundsData.results, apiBaseUrl: 'http://play.soundboard.cloud/api/myinstants.app' }}>
      const playRandomBtn = document.getElementById('playRandomBtn') as HTMLButtonElement;
      const randomSoundContainer = document.getElementById('randomSoundContainer') as HTMLElement;

      function getRandomSound() {
        if (sounds.length === 0) return null;
        const randomIndex = Math.floor(Math.random() * sounds.length);
        return sounds[randomIndex];
      }

      async function loadNewRandomSound() {
        const sound = getRandomSound();
        if (!sound) {
          alert('No sounds available. Please try again later.');
          return;
        }

        // Disable button while loading
        playRandomBtn.disabled = true;
        const originalHTML = playRandomBtn.innerHTML;
        playRandomBtn.innerHTML = 'Loading...';

        // Helper function to create slug
        function slugify(text: string): string {
          return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-')
            .replace(/^-+|-+$/g, '');
        }

        // Generate color for the button (same as SoundButton component)
        const colors = ['#CD6839', '#A464C4', '#7B4FA0', '#9370DB', '#7CCD7C', '#D2691E', '#CD853F', '#66CDAA', '#5DADE2', '#8B7355', '#90EE90', '#FF6347', '#9B59B6', '#5DADE2', '#52C77D', '#F39C12', '#E67E22', '#1ABC9C', '#95A5A6', '#7F8C8D', '#E74C3C', '#8E44AD', '#16A085', '#27AE60', '#D35400', '#34495E', '#C0392B', '#6C3483', '#2874A6', '#138D75'];
        const color = colors[sound.id % colors.length];
        const buttonId = `sound-${sound.id}`;
        const audioUrl = `${apiBaseUrl}/sounds/${sound.id}/audio`; // Use API endpoint
        const soundSlug = slugify(sound.name);

        randomSoundContainer.innerHTML = `
          <div class="random-sound-wrapper">
            <div class="instant">
              <div 
                class="sprite-wrapper"
                role="button"
                aria-label="Play ${sound.name}"
                data-sound-id="${sound.id}"
                data-audio-url="${audioUrl}"
                id="${buttonId}"
              >
                <div 
                  class="inner-btn" 
                  style="background: ${color};"
                ></div>
                <div class="button-ring"></div>
              </div>
              <a href="/instant/${soundSlug}-${sound.id}" class="instant-link link-secondary">${sound.name}</a>
              <div class="result-page-instant-sharebox">
                <button type="button" class="instant-action-button favorite-btn" data-sound-id="${sound.id}" title="Add ${sound.name} to favorites">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="${sound.is_favorited ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: red;">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                  </svg>
                </button>
                <button type="button" class="instant-action-button webshare" data-sound-id="${sound.id}" title="Share ${sound.name}">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: cornflowerblue;">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                  </svg>
                </button>
                <a href="${audioUrl}" download="${sound.name}.mp3" class="instant-action-button download-btn" title="Download ${sound.name}">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: #2ECC71;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        `;

        // Re-enable button
        playRandomBtn.disabled = false;
        playRandomBtn.innerHTML = originalHTML;

        // The SoundButton component's script will automatically initialize the button via MutationObserver
        // No need to manually initialize - the global script in SoundButton.astro handles it
      }

      playRandomBtn.addEventListener('click', loadNewRandomSound);
    </script>
  </body>
</html>

<style>
  .random-page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .random-hero {
    margin-bottom: 3rem;
    max-width: 800px;
  }

  .random-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1.5rem;
    line-height: 1.2;
  }

  .random-description {
    font-size: 1.1rem;
    color: var(--text-secondary);
    line-height: 1.8;
    margin: 0;
  }

  .random-sound-container {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 3rem 0;
    min-height: 300px;
  }

  .random-sound-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Make the sound button bigger on random page */
  .random-sound-wrapper .instant {
    transform: scale(2);
  }

  .random-sound-wrapper .instant .sprite-wrapper {
    width: 200px !important;
    height: 200px !important;
  }

  .random-sound-wrapper .instant .instant-link {
    font-size: 1.4rem;
    margin-top: 2rem;
  }

  .random-button-container {
    margin-top: 3rem;
    margin-bottom: 2rem;
  }

  .random-button {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 3rem;
    background: var(--primary-color);
    color: var(--white);
    border: none;
    border-radius: 12px;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
  }

  .random-button:hover:not(:disabled) {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
  }

  .random-button:active:not(:disabled) {
    transform: translateY(0);
  }

  .random-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .random-button svg {
    animation: none;
  }

  .random-button:hover:not(:disabled) svg {
    animation: spin 0.6s ease-in-out;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .random-page-container {
      padding: 1.5rem 1rem;
    }

    .random-title {
      font-size: 1.75rem;
    }

    .random-description {
      font-size: 1rem;
    }

    .random-sound-wrapper .instant {
      transform: scale(1.5);
    }

    .random-sound-wrapper .instant .sprite-wrapper {
      width: 150px !important;
      height: 150px !important;
    }

    .random-button {
      padding: 1rem 2rem;
      font-size: 1rem;
    }
  }
</style>

