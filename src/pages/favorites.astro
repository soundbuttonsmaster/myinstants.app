---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SoundButton from '../components/SoundButton.astro';

// SEO Meta Data
const pageTitle = 'My Favorites - Saved Sound Buttons | Myinstants';
const pageDescription = 'View and manage your favorite sound buttons on Myinstants. Access all your saved sounds in one place. Create your personal soundboard collection.';
const pageKeywords = 'favorites, saved sounds, my favorites, favorite sound buttons, saved soundboard, personal collection';
const canonicalUrl = 'https://myinstants.app/favorites';
const ogImage = 'https://myinstants.app/images/og-image.jpg';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Primary Meta Tags -->
    <title>{pageTitle}</title>
    <meta name="title" content={pageTitle} />
    <meta name="description" content={pageDescription} />
    <meta name="keywords" content={pageKeywords} />
    <meta name="author" content="Myinstants" />
    <meta name="robots" content="noindex, nofollow" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:image" content={ogImage} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    
    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      "name": "My Favorites",
      "description": pageDescription,
      "url": canonicalUrl
    })} />
    
    <link rel="stylesheet" href="/styles/global.css" />
  </head>
  <body>
    <Header />
    
    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">My Favorites</h1>
        <p class="page-subtitle">All your favorite sound buttons in one place</p>
      </div>

      <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <p>Loading your favorites...</p>
      </div>

      <div id="contentArea" style="display: none;">
        <div class="favorites-stats">
          <div class="stat-card">
            <span class="stat-value" id="totalFavorites">0</span>
            <span class="stat-label">Total Favorites</span>
          </div>
        </div>

        <section class="sounds-section">
          <div class="section-header">
            <div class="section-title-wrapper">
              <h2 class="section-title">Favorite Sounds</h2>
            </div>
          </div>
          <div id="soundsGrid" class="sounds-grid">
            <!-- Sounds will be loaded here -->
          </div>
          <div id="emptyState" class="empty-state" style="display: none;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
            </svg>
            <h3>No Favorites Yet</h3>
            <p>Start exploring sounds and add them to your favorites!</p>
            <a href="/" class="cta-button">Explore Sounds</a>
          </div>
        </section>
      </div>
    </main>

    <Footer />

    <script>
      import { fetchUserFavorites } from '../lib/api';
      import { getAuthToken } from '../lib/auth';

      const token = getAuthToken();
      
      if (!token) {
        window.location.href = '/login';
      }

      async function loadFavorites() {
        const loadingState = document.getElementById('loadingState') as HTMLElement;
        const contentArea = document.getElementById('contentArea') as HTMLElement;
        const soundsGrid = document.getElementById('soundsGrid') as HTMLElement;
        const emptyState = document.getElementById('emptyState') as HTMLElement;
        const totalFavorites = document.getElementById('totalFavorites') as HTMLElement;

        try {
          const data = await fetchUserFavorites(token!, 1, 100);
          
          totalFavorites.textContent = data.count.toString();
          
          if (data.results.length === 0) {
            emptyState.style.display = 'block';
            soundsGrid.innerHTML = '';
          } else {
            emptyState.style.display = 'none';
            // Render sounds in the same format as SoundButton
            soundsGrid.innerHTML = data.results.map(sound => {
              const colors = ['#CD6839', '#A464C4', '#7B4FA0', '#9370DB', '#7CCD7C', '#D2691E', '#CD853F', '#66CDAA', '#5DADE2', '#8B7355'];
              const color = colors[sound.id % colors.length];
              return `
                <div class="instant">
                  <div class="circle small-button-background" style="background-color: ${color};"></div>
                  <button class="small-button" data-sound-id="${sound.id}" data-audio-url="${sound.sound_file}" id="sound-${sound.id}" title="${sound.name}" type="button"></button>
                  <div class="small-button-shadow"></div>
                  <a href="/instant/${sound.name.toLowerCase().replace(/[^\w\s-]/g, '').replace(/[\s_-]+/g, '-').replace(/^-+|-+$/g, '')}-${sound.id}" class="instant-link link-secondary">${sound.name}</a>
                  <div class="result-page-instant-sharebox" style="margin-top: 8px;">
                    <button type="button" class="instant-action-button favorite-btn" data-sound-id="${sound.id}" title="Add ${sound.name} to favorites">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="${sound.is_favorited ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: red;">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                      </svg>
                    </button>
                    <button type="button" class="instant-action-button" data-sound-id="${sound.id}" title="Copy link: ${sound.name}">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.4rem; color: LightSeaGreen;">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                      </svg>
                    </button>
                    <button type="button" class="instant-action-button webshare" data-sound-id="${sound.id}" title="Share ${sound.name}">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="font-size: 1.3rem; color: cornflowerblue;">
                        <circle cx="18" cy="5" r="3"/>
                        <circle cx="6" cy="12" r="3"/>
                        <circle cx="18" cy="19" r="3"/>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                      </svg>
                    </button>
                  </div>
                </div>
              `;
            }).join('');
            
            // Initialize audio playback for the rendered buttons
            initializeSoundButtons();
          }
          
          loadingState.style.display = 'none';
          contentArea.style.display = 'block';
        } catch (error) {
          console.error('Failed to load favorites:', error);
          loadingState.innerHTML = '<p>Failed to load favorites. Please try again.</p>';
        }
      }

      function initializeSoundButtons() {
        const buttons = document.querySelectorAll('.small-button');
        const audioCache = new Map();

        buttons.forEach((button) => {
          const audioUrl = button.getAttribute('data-audio-url');
          const soundId = button.getAttribute('data-sound-id');
          
          if (!audioUrl) return;

          const audio = new Audio(audioUrl);
          audioCache.set(soundId, audio);

          button.addEventListener('mousedown', () => {
            button.classList.add('pressed');
            const cachedAudio = audioCache.get(soundId);
            if (cachedAudio) {
              cachedAudio.currentTime = 0;
              cachedAudio.play().catch(err => console.error('Audio play failed:', err));
            }
          });

          button.addEventListener('mouseup', () => {
            button.classList.remove('pressed');
          });

          button.addEventListener('mouseleave', () => {
            button.classList.remove('pressed');
          });

          button.addEventListener('touchstart', (e) => {
            e.preventDefault();
            button.classList.add('pressed');
            const cachedAudio = audioCache.get(soundId);
            if (cachedAudio) {
              cachedAudio.currentTime = 0;
              cachedAudio.play().catch(err => console.error('Audio play failed:', err));
            }
          });

          button.addEventListener('touchend', (e) => {
            e.preventDefault();
            button.classList.remove('pressed');
          });
        });
      }

      loadFavorites();
    </script>
  </body>
</html>

<style>
  .page-header {
    margin-bottom: 2rem;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .page-subtitle {
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .loading-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .favorites-stats {
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--white);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: 3rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 1.1rem;
    color: var(--text-secondary);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
  }

  .empty-state svg {
    margin-bottom: 1rem;
    color: var(--text-light);
  }

  .empty-state h3 {
    font-size: 1.5rem;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    margin-bottom: 1.5rem;
  }

  /* Sound button styles (matching SoundButton component) */
  .instant {
    position: relative;
    vertical-align: top;
    width: 120px;
    text-align: center;
    word-wrap: break-word;
    display: inline-block;
  }

  .circle.small-button-background {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 0;
    overflow: hidden;
  }

  .small-button-shadow {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 120px;
    height: 120px;
    z-index: 0;
  }

  .instant-link.link-secondary {
    text-decoration: underline;
    color: var(--text-primary);
    font-size: 14px;
    display: block;
    margin-top: 8px;
    word-wrap: break-word;
    line-height: 1.3;
    text-align: center;
  }

  .result-page-instant-sharebox {
    display: flex;
    justify-content: center;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
  }

  .instant-action-button {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
  }

  .instant-action-button:hover {
    opacity: 0.7;
  }

  .small-button {
    width: 120px;
    height: 120px;
    position: absolute;
    background: url('/images/transparent_button_small.png') no-repeat;
    background-position: 0% 0;
    background-size: 200% 100%;
    border: 0;
    display: block;
    cursor: pointer;
    padding: 0;
    z-index: 1;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    -webkit-tap-highlight-color: transparent;
    transition: none;
    overflow: hidden;
    border-radius: 50%;
    mix-blend-mode: multiply;
  }

  .small-button:active,
  .small-button.pressed {
    background-position: 100% 0 !important;
  }
</style>

